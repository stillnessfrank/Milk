@{
    ViewBag.Title = "资产管理";
    Layout = "~/Views/Shared/_Layout6.cshtml";
}
<!-- begin #content -->
<div id="content" class="content" style="padding: 0; height: 100%;">
    <!-- begin page-header -->
    <div id="page-header" style="height: 45px;line-height: 45px;background:  #D9E0E7;overflow: hidden;">
        <ul class="nav nav-pills">
            <li style="margin-left: 20px;font-size: 14px">资产管理 &nbsp; |</li>
            <li>
                <a href="~/PropertyMgr/Index"  style="padding:0;width: 50px;text-align: center">
                    <i class="fa fa-search"></i>
                </a>
            </li>
            <li>
                <a href="~/PropertyMgr/AddProperty" style="padding:0;width: 50px;text-align: center;font-size: 18px;">
                    <i class="icon iconfont icon-tianjiazulinhetong"></i>
                </a>
            </li>
            <li class="active">
                <a href="#nav-pills-tab-3" data-toggle="tab" style="padding:0;width: 50px;text-align: center;font-size: 18px;">
                    <i class="fa  fa-home"></i>
                </a>
            </li>
            <li>
                <a href="~/PropertyMgr/AddRoom" style="padding:0;width: 50px;text-align: center;font-size: 18px;">
                    <i class="icon iconfont icon-tianjiafangyuanyuding"></i>
                </a>
            </li>
            <li style="float: right;margin-right: 20px;">
                <a href="~/Home/Index" style="padding:0;width: 50px;text-align: center">
                    <i class="icon iconfont icon-fanhui" style="font-size: 20px;"></i>
                </a>
            </li>
            <li style="float: right;overflow: hidden;">
                <form class="navbar-form full-width" style="margin: 0;">
                    <div class="form-group">
                        <input type="text" class="form-control" id="inputSearch" placeholder="搜索" />
                        <button type="button" class="btn btn-search" id="btnSearch" style="top: 8px;"><i class="fa fa-search"></i></button>
                    </div>
                </form>
            </li>
        </ul>
    </div>
    <!-- end page-header -->
    <div class="tab-content" id="tab-content" style="height: 100%;">
        <div class="tab-pane fade active in" id="nav-pills-tab-3">
            <div class="row" style="padding: 10px 5px;;margin: 0;">
                <!-- begin col-12 -->
                <div class="col-md-12">
                    <table id="data-table" class="table table-striped table-bordered">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>资产编号</th>
                                <th>房地地址</th>
                                <th>房间编号</th>
                                <th>房间名称</th>
                                <th>建筑面积</th>
                                <th>使用面积</th>
                                <th>租赁状态</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                </div>
                <!-- end col-12 -->
            </div>
        </div>
    </div>
</div>
<!-- #编辑弹框 -->
<!-- #编辑弹框 -->
<div class="modal fade" id="edit">
    <div class="modal-dialog" style="width: 1000px;">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                <h4 class="modal-title">编辑房屋信息</h4>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editId" />
                <div class="row" style="margin: 0;">
                    <!-- begin col-6 -->
                    <div class="col-md-12">
                        <!-- begin panel -->
                        <div class="panel panel-inverse" data-sortable-id="form-stuff-1" style="margin-top: 2%;">
                            <div class="panel-body">
                                <form class="form-horizontal " id="form-room">
                                    <div class="form-group">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <label class="col-md-2 control-label col-md-offset-2">资产编号:</label>
                                                <div class="col-md-8">
                                                    <select class="form-control" id="propertyId" name="propertyId"></select>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <label class="col-md-2 control-label col-md-offset-2">房地地址：:</label>
                                                <div class="col-md-8">
                                                    <input type="text" class="form-control" id="certificateAddress" name="certificateAddress"/>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <label class="col-md-2 control-label col-md-offset-2">房间名称：</label>
                                                <div class="col-md-8">
                                                    <input type="text" class="form-control" id="roomName" name="roomName"/>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <label class="col-md-2 control-label col-md-offset-2">房间编号：</label>
                                                <div class="col-md-8">
                                                    <input type="text" class="form-control" id="roomCode" name="roomCode"/>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <label class="col-md-2 control-label col-md-offset-2">建筑面积：</label>
                                                <div class="col-md-8">
                                                    <input type="text" class="form-control" id="buildingArea" name="buildingArea"/>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <label class="col-md-2 control-label col-md-offset-2">使用面积：</label>
                                                <div class="col-md-8">
                                                    <input type="text" class="form-control" id="usageArea" name="usageArea"/>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <label class="col-md-2 control-label col-md-offset-2">租赁状态：</label>
                                                <div class="col-md-8">
                                                    <select class="form-control" id="rentStatusCode" name="rentStatusCode">
                                                        <option value="1">待租</option>
                                                        <option value="2">已租</option>
                                                    </select>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <label class="col-md-2 control-label col-md-offset-2">封面图片：</label>
                                                <div class="col-md-8">
                                                    <input type="file" id="coverPhoto" name="coverPhoto"/>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <label class="col-md-2 control-label col-md-offset-2" style="font-size: 16px; color: #9f191f;"> 相册：</label>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label class="col-md-1 control-label col-md-offset-1">上传图片：</label>
                                        <div class="col-md-10">
                                            <input type="file"/>
                                        </div>
                                    </div>
                                    <div class="from-group">
                                        <label class="col-md-1 control-label col-md-offset-1"></label>
                                        <div class="col-md-10" style="padding-left: 5px;">
                                            <div class="image" style="width: 140px; overflow: hidden; float: left; margin-right: 10px;">
                                                <div class="image-inner">
                                                    <a href="javascript:;" data-lightbox="gallery-group-1">
                                                        <img src="/theme/assets/img/fujian.png" alt="" style="width: 140px; height: 180px;"/>
                                                    </a>
                                                </div>
                                                <div class="image-info text-center">
                                                    <h5 class="title text-center">File NAME</h5>
                                                    <div class="text-center">
                                                        <a href="javascript:;"><i class="icon iconfont icon-shanchu"></i></a>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>
                        <!-- end panel -->
                    </div>
                    <!-- end col-6 -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-sm btn-white" data-dismiss="modal" style="padding: 8px 20px;">取消</button>
                <button class="btn btn-sm btn-success" id="btnSave" style="padding: 8px 20px;">保存</button>
            </div>
        </div>
    </div>
</div>
@section Styles{
    <style>
        /*#page-header{*/
        /*display: flex;*/
        /*justify-content: space-around;*/
        /*}*/
        #page-header form {
            float: left;
        }

        #page-header form select {
            width: 98px;
        }

        .navbar-brand {
            width: 320px;
        }

        #tankuang {
            width: 300px;
            position: absolute;
            ;
            right: 0px;
            top: 100px;
            overflow: auto;
        }
        /*滚动条样式*/
        #tankuang::-webkit-scrollbar { /*滚动条整体样式*/
            width: 6px; /*高宽分别对应横竖滚动条的尺寸*/
            height: 6px;
        }

        #tankuang::-webkit-scrollbar-thumb { /*滚动条里面小方块*/
            border-radius: 5px;
            -webkit-box-shadow: inset 0 0 5px rgba(0,0,0,0.2);
            background: rgba(0,0,0,0.2);
        }

        #tankuang::-webkit-scrollbar-track { /*滚动条里面轨道*/
            -webkit-box-shadow: inset 0 0 5px rgba(0,0,0,0.2);
            border-radius: 0;
            background: rgba(0,0,0,0.1);
        }

        #tankuang .panel {
            background: rgba(255,255,255,0.5);
        }

        .row > [class*=col-].ui-sortable {
            min-height: 0;
        }

        #tab-content {
            padding: 0;
            margin: 0;
        }

        #data-table td a {
            font-size: 18px;
            margin-right: 20px;
        }

        #data-table td a:last-child {
            margin-right: 0;
        }

        #data-table2 td a {
            font-size: 18px;
            margin-right: 20px;
        }

        #data-table2 td a:last-child {
            margin-right: 0;
        }

        .form-horizontal .form-group {
            margin-left: 0;
            margin-right: 0;
        }

        .form-horizontal h4 {
            color: #a94442;
            font-size: 17px;
            /*color: #0d6aad;*/
        }

        .nav2 li {
            margin-top: 10px;
        }

        .bwizard-steps li.active, .bwizard-steps li.active:focus, .bwizard-steps li.active:hover {
            background: #ff5b57 !important;
        }

        .form-control-feedback {
            right: -26px;
            margin-right: 10px;
            color: #ff3245;
        }

        .control-label {
            text-align: left !important;
        }
    /*#tankuang .row .panel-body{*/
        /*background:rgba(255,255,255,0.5)!important;*/
        /*}*/
    </style>
}

@section scripts{
    <script src="~/theme/assets/js/apps.min.js"></script>
    <script src="~/Scripts/underscore-min.js"></script>
    <script src="~/js/main.js"></script>
    <script type="text/template" id="dtTpl">
        <%
        _.each(data, function(n,i){
        %>
        <tr>
            <td><%= i+1 %></td>
            <td><%= n.propertyCode %></td>
            <td><%= n.certificateAddress%></td>
            <td><%= n.roomCode %></td>
            <td><%= n.roomName %></td>
            <td><%= n.buildingArea %></td>
            <td><%= n.usageArea %></td>
            <td><%= n.rentStatus %></td>
            <td class="text-center">
                <a href="javascript:;" data-id="<%= n.id %>" class="btn-delete"><i class="icon iconfont icon-shanchu"></i></a>
                <a href="javascript:;" data-id="<%= n.id %>" class="btn-edit"><i class="icon iconfont icon-bianji"></i></a>
            </td>
        </tr>
        <% }); %>
    </script>
    <script>
        var propertyService = abp.services.app.propertyAppServices;
        function getTable() {
            var $dt = $('#data-table');
            //abp.ui.setBusy($dt);
            propertyService.getAllRooms().done(function (data) {
                console.log(data);
                if (data != null && data.length > 0) {
                    var tpl = _.template($('#dtTpl').html());
                    $dt.find("tbody").remove();
                    $dt.append("<tbody></tbody>");
                    $dt.find("tbody").append(tpl({ data: data }));
                } else {
                    $dt.find("tbody").remove();
                    $dt.append("<tbody></tbody>");
                }

                 $dt.DataTable({
                    "destroy": true,
                    "bInfo": true,
                    "pageLength": 10,
                    "columnDefs": [{
                        'targets': [8],
                        'orderable': false
                    }],
                    language: {
                        "sProcessing": "处理中...",
                        "sLengthMenu": "显示 _MENU_ 项结果",
                        "sZeroRecords": "没有匹配结果",
                        "sInfo": "显示第 _START_ 至 _END_ 项结果，共 _TOTAL_ 项",
                        "sInfoEmpty": "显示第 0 至 0 项结果，共 0 项",
                        "sInfoFiltered": "(由 _MAX_ 项结果过滤)",
                        "sInfoPostFix": "",
                        "sSearch": "搜索:",
                        "sUrl": "",
                        "sEmptyTable": "表中数据为空",
                        "sLoadingRecords": "载入中...",
                        "sInfoThousands": ",",
                        "oPaginate": {
                            "sFirst": "首页",
                            "sPrevious": "上页",
                            "sNext": "下页",
                            "sLast": "末页"
                        },
                        "oAria": {
                            "sSortAscending": ": 以升序排列此列",
                            "sSortDescending": ": 以降序排列此列"
                        }
                    },
                    autoFill: true,
                    responsive: true,
                    "lengthChange": false,   //选择每页显示多少条数据，下拉选项
                    "aLengthMenu": [[4, 10, 25, 100], [4, 10, 25, 100]] // 定义每页显示数据数量
                });

                $("#data-table_filter").hide();

                $dt.find("tbody").on("click", ".btn-edit", function () {
                    $("#editId").val($(this).attr("data-id"));
                    $("#edit").modal("show");

                });
                $dt.find("tbody").on("click", ".btn-delete", function () {
                    deleteItem($(this).attr("data-id"));
                });

            }).always(function () {
                //abp.ui.clearBusy($dt);
            });

        }

        function deleteItem(id) {
            abp.message.confirm(
                '是否删除房间?',
                '删除确认',
                function (isConfirmed) {
                    if (isConfirmed) {
                        abp.ui.setBusy("body");
                        var input = { id: id };
                        propertyService.deleteRoom(input).done(function () {
                            abp.message.success('删除房间成功！', '操作成功');
                            getTable();
                        }).always(function () {
                            abp.ui.clearBusy("body");
                        });
                    }
                }
            );
        }

        $(document).ready(function () {
            $("#global_search").hide();
            getTable();
            //TableManageAutofill.init();
            //TableManageAutofill2.init();
            App.init();
            $('.sidebar-minify-btn').click().hide();
            FormWizard.init();
            FormWizard1.init();
            $('.well').height($('body').height() * 0.6).css("overflow", "auto");
            $(window).resize(function () {          //当浏览器大小变化时
                $('.well').height($('body').height() * 0.5).css("overflow", "auto");
            });
            FormPlugins.init();

            $("#inputSearch").on("keyup", function () {
                $('#data-table').DataTable().search($("#inputSearch").val()).draw();
            });

            var $roomForm = $("#form-room");

            $roomForm.validate();

            $("#propertyId").on("change",
                function () {
                    var propertyId = $("#propertyId").val();
                    $("#certificateAddress").val("");
                    var input = { id: propertyId };
                    propertyService.getPropertyInfoByPropId(input).done(function (data) {
                        if (data != null) {
                            $("#certificateAddress").val(data.certificateAddress);
                        }
                    });
                });

            $("#edit").on('shown.bs.modal',
                function () {
                    var id = $("#editId").val();
                    var input = { id: id };
                    propertyService.getRoomById(input).done(function (roomData) {
                        if (roomData != null) {
                            propertyService.getAllProperty().done(function (data) {
                                if (data.length > 0) {
                                    $("#propertyId").empty();
                                    var options = [];
                                    $.each(data,
                                        function (i, obj) {
                                            var option = "<option value='" + obj.id + "'>" + obj.propertyCode + "</option>";
                                            if (obj.id == data.propertyId) {
                                                option = "<option value='" + obj.id + "' selected>" + obj.propertyCode + "</option>";
                                            }
                                            options.push(option);
                                        });
                                    $("#propertyId").append(options.join(''));

                                    $("#form-room").find("input,select,textarea").each(function (i, obj) {
                                        $(obj).val(roomData[$(obj).attr("name")]);
                                    });

                                    $("#propertyId").trigger("change");
                                }
                            });
                        }
                    });
                });

            $("#btnSave").on("click", function () {
                var id = $("#editId").val();
                if (!$roomForm.valid()) {
                    return;
                }
                var room = $roomForm.serializeFormToObject();
                room.id = id;
                
                abp.ui.setBusy($("body"));
                propertyService.updateRoom(room).done(function () {
                    abp.message.success('编辑房间成功！', '操作成功');
                    $("input[type=text] textarea").val("");
                    $("#edit").modal("hide");
                    
                    getTable();
                }).always(function () {
                    abp.ui.clearBusy($("body"));
                });
            });
        });
    </script>
}
